<html>
<head>
<meta charset=utf-8 />
<title>A simple map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
<script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; font-family: roboto;}
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #switch {
    position: absolute;
    left:50px;
    bottom: 50px;
    width:480px;
    height:50px;
    border-radius: 5px;
    background-color: #fff;
    overflow: hidden;
  }
  #switch .button {
    width:50px;
    height: 40px;
    text-align: center;
    padding: 15px 5px 0px 5px;
    float: left;
  }
  .range {
    width:450px;
    margin: 15px;
  }
</style>
</head>
<body>
<div id='map'></div>
<div id="menu_ui"></div>


<script>

    var month = "jan";
    var prices;
    var source; // для нашего json файла
    var color_price;
    var monthList = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];


// Подключаем данные
    $.getJSON("europe_prices_true.json", function(result) {
      prices = result;
      start();
    });

function start() { // засовываем в отдельную функцию тк надо дождаться чтобы завершилась загрузка json
    // берем токен
    L.mapbox.accessToken = 'pk.eyJ1IjoibGFyZHp6IiwiYSI6ImNpaGM3eGxtdDAwMDN2M2phd3c1emlreGQifQ.Ih7ZCLa7CR291uw0W-zTmA';

    // включаем карту
    var map = L.mapbox.map('map').setView([55.744537,37.625224], 5);

    // добавляем стиль подложки
    L.mapbox.styleLayer('mapbox://styles/lardzz/cihryj0in00bjbnm30ahifluo').addTo(map);

    // красим страны
    function getColor (x) { // x - идентификатор страны "AUS" типа
      if (prices[x]) {
      return prices[x][month] > 500 ? "#0000ff" :
             prices[x][month] > 400 ? "#4400bb" :
             prices[x][month] > 300 ? "#670098" :
             prices[x][month] > 200 ? "#ba0045" :
             prices[x][month] > 100 ? "#ea0015" :
             "#0000ff";
       } else return "rgba(0,0,0,1)";
    }

/*  функция которая перебирает и сравнивает массивы но не нужна
    function check (src, prc) {
      var x = [];
      src.features.forEach(function (a) {
        // if (prc[a.properties.iso_a3]) console.log(a.properties.iso_a3 + " jan price: " + prc[a.properties.iso_a3].jan);
        if (prc[a.properties.iso_a3]) {
          console.log("jan == " + prc[a.properties.iso_a3].jan);
          x.push(prc[a.properties.iso_a3].jan);
        }
      });
      console.log("x == " + x);
      return x;
    }
*/

    function stylefunc(current_country) {  // current_country это такой параметр который передается независимо от того что мы его не определили
      return {
          fillColor: getColor(current_country.properties.iso_a3),
          weight: 1,
          opacity: 0.2,
          color: 'white',
          dashArray: '2',
          fillOpacity: 0.7
      };
    }

    //очищаем объекты предыдущие
    function reloadMap(mnth) {
      month = mnth;
      MyfeatureLayer.clearLayers(); // !!! очищаем, еее
      L.geoJson(source, {style:stylefunc}).addTo(MyfeatureLayer);
    }

    // вот мы грузим цветные карты
    var MyfeatureLayer = L.mapbox.featureLayer().addTo(map); //.addTo(map);
    L.mapbox.featureLayer().loadURL('countries.geoJson').on('ready', function(e) {
      source = e.target.getGeoJSON();
      reloadMap("jan");
    });

    MyfeatureLayer.on('click', function(e) {
      reloadMap("feb");
    });

    var range = document.getElementById('range');
    range.addEventListener("change", function() {
      reloadMap(monthList[range.value]);
    });
}
</script>

<div id="switch">
  <!--
  <div class="button" onclick="reloadMap('jan')">JAN</div>
  <div class="button" onclick="reloadMap('feb')">FEB</div>
  -->
  <input id='range' class='range' value='0' type='range' min='0' max='11' step='1' />
</div>

</body>
</html>
